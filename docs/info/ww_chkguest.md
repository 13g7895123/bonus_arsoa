# ww_chkguest 預儲程序 API 使用說明

## 概述
ww_chkguest 是 MSSQL 預儲程序，用於驗證和創建來賓身份。系統提供兩個 API 端點分別用於測試模式和正式模式。

## 預儲程序參數說明

### 輸入參數
- `@test` (smallint): 模式選擇
  - 1: 測試模式（驗證資料但不創建編號）
  - 0: 正式模式（創建來賓編號並寫入資料庫）
- `@d_spno` (char(7)): 推薦人編號（填寫資料的會員代號）
- `@cname` (nvarchar(20)): 來賓姓名
- `@bdate` (varchar(8)): 來賓生日（格式：YYYYMMDD）
- `@cell` (varchar(20)): 電話（已移除，API 自動傳空字串給預儲程序）

### 回傳值 (errcode)
- **0**: 來賓身分通過驗證（正式模式會產生來賓編號）
- **1**: 已存在此來賓（傳回該來賓的編號 c_no）
- **2**: 已存在此來賓，但推薦人不同
- **3**: 此來賓已經是會員了

## API 端點

### 1. 測試模式 API

**端點：** `GET /api/eeform1/ww_chkguest_test`

**用途：** 驗證來賓資料是否正確，不會實際創建來賓編號

**參數：**
| 參數名稱 | 類型 | 必填 | 說明 | 範例 |
|---------|------|------|------|------|
| d_spno | string | 否 | 推薦人編號（預設：000000） | 000000 |
| cname | string | 是 | 來賓姓名 | 張三 |
| bdate | string | 是 | 生日（YYYYMMDD） | 19900101 |

**請求範例：**
```
GET /api/eeform1/ww_chkguest_test?d_spno=000000&cname=張三&bdate=19900101
```

**成功回應範例：**
```json
{
  "success": true,
  "code": 200,
  "message": "ww_chkguest 預儲程序測試完成",
  "data": {
    "success": true,
    "errcode": 0,
    "message": "來賓身分通過驗證",
    "guest_id": null
  },
  "timestamp": "2024-01-01 12:00:00"
}
```

**錯誤回應範例：**
```json
{
  "success": false,
  "code": 400,
  "message": "來賓姓名不能為空",
  "timestamp": "2024-01-01 12:00:00"
}
```

### 2. 正式模式 API

**端點：** `POST /api/eeform1/ww_chkguest_create`

**用途：** 實際創建來賓編號並寫入資料庫

**請求標頭：**
```
Content-Type: application/json
```

**請求主體參數：**
| 參數名稱 | 類型 | 必填 | 說明 | 範例 |
|---------|------|------|------|------|
| d_spno | string | 是 | 推薦人編號 | 000000 |
| cname | string | 是 | 來賓姓名 | 張三 |
| bdate | string | 是 | 生日（YYYYMMDD） | 19900101 |

**請求範例：**
```json
POST /api/eeform1/ww_chkguest_create

{
  "d_spno": "000000",
  "cname": "張三",
  "bdate": "19900101"
}
```

**成功回應範例：**
```json
{
  "success": true,
  "code": 200,
  "message": "來賓創建成功",
  "data": {
    "success": true,
    "errcode": 0,
    "message": "來賓身分通過驗證並創建成功",
    "guest_id": "G123456"
  },
  "timestamp": "2024-01-01 12:00:00"
}
```

**錯誤回應範例：**
```json
{
  "success": false,
  "code": 400,
  "message": "已存在此來賓，但推薦人不同",
  "errors": {
    "errcode": 2,
    "guest_id": "G123456",
    "details": {
      "success": false,
      "errcode": 2,
      "message": "已存在此來賓，但推薦人不同"
    }
  },
  "timestamp": "2024-01-01 12:00:00"
}
```

## 實際使用流程

### 在表單頁面 (/eform/eform1?identity=guest) 的整合流程：

1. **使用者填寫資料**
   - 當使用者在來賓模式下填寫會員姓名、出生年月日欄位
   - 系統會在離開欄位時檢查是否兩個欄位都已填寫

2. **自動驗證（測試模式）**
   - 當兩個必填欄位都有資料時，自動呼叫測試模式 API
   - 顯示載入提示：「確認來賓資料，請稍後」
   - 根據回傳的 errcode 顯示結果：
     - errcode ≤ 1：顯示「檢測成功，請繼續填寫表單」
     - errcode > 1：顯示「檢驗錯誤，請確認資料是否有誤」

3. **表單提交（正式模式）**
   - 使用者完成所有表單填寫並提交時
   - 系統呼叫正式模式 API 創建來賓編號
   - 取得的來賓編號（guest_id）存入 member_id 欄位
   - 完成表單提交流程

## 注意事項

1. **電話參數已完全移除**：前端不需要傳送電話參數，API 會自動傳送空字串給預儲程序的 cell 參數

2. **生日格式**：必須是 8 位數字的 YYYYMMDD 格式，例如：19900101

3. **推薦人編號**：測試模式可不填（預設為 000000），正式模式為必填

4. **錯誤處理**：請根據不同的 errcode 給予使用者適當的提示訊息

5. **資料驗證**：
   - 推薦人編號不超過 7 個字符
   - 來賓姓名不超過 20 個字符
   - 生日必須符合 YYYYMMDD 格式

## 錯誤碼對照表

| errcode | 說明 | 建議處理方式 |
|---------|------|-------------|
| 0 | 來賓身分通過驗證 | 允許繼續操作 |
| 1 | 已存在此來賓 | 使用現有編號，允許繼續 |
| 2 | 已存在但推薦人不同 | 提示使用者確認推薦人資訊 |
| 3 | 此來賓已是會員 | 提示使用者改用會員身份登入 |
| -1 | 系統錯誤 | 提示系統異常，請稍後再試 |