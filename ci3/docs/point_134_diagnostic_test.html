<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Point 134 診斷測試 - EForm5 API</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #dc3545;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ccc;
            background-color: #f8f9fa;
        }
        .test-result.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .test-result.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .test-result.warning {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        .btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover {
            background-color: #c82333;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .diagnostic-info {
            background-color: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .step-counter {
            display: inline-block;
            background-color: #6c757d;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            text-align: center;
            line-height: 25px;
            font-size: 12px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Point 134 診斷測試</h1>
        <p><strong>問題描述:</strong> /wadmin/admin_eeform/eeform_manage_eeform05 頁面載入 API /api/eeform/eeform5/list?page=1&limit=20 時出現 "Cannot read properties of undefined (reading 'total')" 錯誤，儘管 API 返回 200 狀態。</p>

        <div class="diagnostic-info">
            <h3>🎯 診斷步驟</h3>
            <p>這個測試將逐步診斷問題，從基本連接到資料結構驗證。</p>
        </div>

        <button class="btn" onclick="runFullDiagnosis()">🚀 執行完整診斷</button>
        <button class="btn" onclick="clearResults()" style="background-color: #6c757d;">🧹 清除結果</button>

        <div id="test-results"></div>
    </div>

    <script>
        const API_BASE_URL = '/api/eeform/eeform5';
        const ADMIN_PAGE_URL = '/wadmin/admin_eeform/eeform_manage_eeform05';
        
        function log(message) {
            console.log(`[Point 134 診斷] ${new Date().toISOString()}: ${message}`);
        }

        function addTestResult(title, status, content, details = null) {
            const resultsDiv = document.getElementById('test-results');
            const testDiv = document.createElement('div');
            testDiv.className = `test-result ${status}`;
            
            let statusIcon = '🔄';
            if (status === 'success') statusIcon = '✅';
            else if (status === 'error') statusIcon = '❌';
            else if (status === 'warning') statusIcon = '⚠️';
            
            let html = `<h4>${statusIcon} ${title}</h4><p>${content}</p>`;
            
            if (details) {
                html += `<div class="code-block">${details}</div>`;
            }
            
            testDiv.innerHTML = html;
            resultsDiv.appendChild(testDiv);
        }

        async function runFullDiagnosis() {
            document.getElementById('test-results').innerHTML = '';
            
            log('開始執行 Point 134 完整診斷');
            
            // Step 1: API 基本連接測試
            await testStep1_BasicConnection();
            
            // Step 2: 資料表檢查
            await testStep2_TableCheck();
            
            // Step 3: 資料結構驗證
            await testStep3_DataStructure();
            
            // Step 4: 前端期望格式驗證
            await testStep4_FrontendExpectation();
            
            // Step 5: 模擬前端處理邏輯
            await testStep5_FrontendLogic();
            
            log('Point 134 診斷完成');
        }

        async function testStep1_BasicConnection() {
            addTestResult(
                '步驟 1: API 基本連接測試',
                'info',
                '測試 API 端點是否可以正常連接...'
            );
            
            try {
                const response = await fetch(`${API_BASE_URL}/test`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    addTestResult(
                        '步驟 1: API 基本連接測試',
                        'success',
                        `API 連接正常，狀態碼: ${response.status}`,
                        JSON.stringify(data, null, 2)
                    );
                } else {
                    addTestResult(
                        '步驟 1: API 基本連接測試',
                        'error',
                        `API 連接失敗，狀態碼: ${response.status}`,
                        JSON.stringify(data, null, 2)
                    );
                }
            } catch (error) {
                addTestResult(
                    '步驟 1: API 基本連接測試',
                    'error',
                    `連接失敗: ${error.message}`,
                    `URL: ${API_BASE_URL}/test\n錯誤: ${error.stack}`
                );
            }
        }

        async function testStep2_TableCheck() {
            addTestResult(
                '步驟 2: 資料表存在檢查',
                'info',
                '檢查 EForm5 相關資料表是否存在...'
            );
            
            try {
                const response = await fetch(`${API_BASE_URL}/test`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.table_exists !== undefined) {
                    if (data.table_exists) {
                        addTestResult(
                            '步驟 2: 資料表存在檢查',
                            'success',
                            '資料表存在檢查通過',
                            `資料表狀態: ${data.table_exists ? '存在' : '不存在'}`
                        );
                    } else {
                        addTestResult(
                            '步驟 2: 資料表存在檢查',
                            'error',
                            '資料表不存在！這可能是問題的根源',
                            '建議: 執行資料表創建 SQL 或檢查資料庫連接'
                        );
                    }
                } else {
                    addTestResult(
                        '步驟 2: 資料表存在檢查',
                        'warning',
                        'API 沒有返回資料表狀態資訊',
                        JSON.stringify(data, null, 2)
                    );
                }
            } catch (error) {
                addTestResult(
                    '步驟 2: 資料表存在檢查',
                    'error',
                    `檢查失敗: ${error.message}`,
                    error.stack
                );
            }
        }

        async function testStep3_DataStructure() {
            addTestResult(
                '步驟 3: 資料結構驗證',
                'info',
                '測試問題 API 端點的資料結構...'
            );
            
            try {
                const response = await fetch(`${API_BASE_URL}/list?page=1&limit=20`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                const rawText = await response.text();
                let data;
                
                try {
                    data = JSON.parse(rawText);
                } catch (parseError) {
                    addTestResult(
                        '步驟 3: 資料結構驗證',
                        'error',
                        'API 回傳的不是有效的 JSON',
                        `狀態碼: ${response.status}\n原始回應: ${rawText.substring(0, 500)}`
                    );
                    return;
                }
                
                addTestResult(
                    '步驟 3: 資料結構驗證',
                    response.ok ? 'success' : 'error',
                    `API 回應狀態: ${response.status}`,
                    JSON.stringify(data, null, 2)
                );
                
                // 驗證 data 結構
                if (data.success) {
                    let structureIssues = [];
                    
                    if (!data.data) {
                        structureIssues.push('缺少 data 欄位');
                    } else {
                        if (!data.data.data) {
                            structureIssues.push('缺少 data.data 欄位');
                        }
                        if (!data.data.pagination) {
                            structureIssues.push('缺少 data.pagination 欄位');
                        } else {
                            const pagination = data.data.pagination;
                            if (pagination.total === undefined) structureIssues.push('缺少 pagination.total');
                            if (pagination.current_page === undefined) structureIssues.push('缺少 pagination.current_page');
                            if (pagination.total_pages === undefined) structureIssues.push('缺少 pagination.total_pages');
                            if (pagination.per_page === undefined) structureIssues.push('缺少 pagination.per_page');
                        }
                    }
                    
                    if (structureIssues.length === 0) {
                        addTestResult(
                            '步驟 3a: 資料結構詳細驗證',
                            'success',
                            '資料結構完全符合前端期望！',
                            `✅ data.data: ${Array.isArray(data.data.data) ? data.data.data.length : 'N/A'} 筆記錄
✅ data.pagination.total: ${data.data.pagination.total}
✅ data.pagination.current_page: ${data.data.pagination.current_page}
✅ data.pagination.total_pages: ${data.data.pagination.total_pages}
✅ data.pagination.per_page: ${data.data.pagination.per_page}`
                        );
                    } else {
                        addTestResult(
                            '步驟 3a: 資料結構詳細驗證',
                            'error',
                            '資料結構不符合前端期望！',
                            `❌ 問題:\n${structureIssues.join('\n')}\n\n實際結構:\n${JSON.stringify(data, null, 2)}`
                        );
                    }
                } else {
                    addTestResult(
                        '步驟 3a: 資料結構詳細驗證',
                        'error',
                        'API 回傳 success: false',
                        `錯誤訊息: ${data.message || '未知錯誤'}`
                    );
                }
                
            } catch (error) {
                addTestResult(
                    '步驟 3: 資料結構驗證',
                    'error',
                    `請求失敗: ${error.message}`,
                    error.stack
                );
            }
        }

        async function testStep4_FrontendExpectation() {
            addTestResult(
                '步驟 4: 前端期望格式驗證',
                'info',
                '驗證前端 JavaScript 期望的資料格式...'
            );
            
            const expectedStructure = {
                success: true,
                data: {
                    data: [], // 表格資料陣列
                    pagination: {
                        total: 0, // <- 這是導致 "Cannot read properties of undefined (reading 'total')" 的欄位
                        current_page: 1,
                        total_pages: 1,
                        per_page: 20
                    }
                }
            };
            
            addTestResult(
                '步驟 4: 前端期望格式驗證',
                'success',
                '前端 JavaScript 期望以下資料結構:',
                `// 前端代碼 (form5.php 第619行):
admin.totalRecords = data.data.pagination.total;

// 期望的 API 回應格式:
${JSON.stringify(expectedStructure, null, 2)}`
            );
        }

        async function testStep5_FrontendLogic() {
            addTestResult(
                '步驟 5: 模擬前端處理邏輯',
                'info',
                '模擬前端如何處理 API 回應...'
            );
            
            try {
                const response = await fetch(`${API_BASE_URL}/list?page=1&limit=20`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                // 模擬前端邏輯
                let frontendErrors = [];
                
                try {
                    // 這是會產生錯誤的行
                    const totalRecords = data.data.pagination.total;
                    addTestResult(
                        '步驟 5a: 模擬前端邏輯',
                        'success',
                        `成功讀取 pagination.total: ${totalRecords}`,
                        `data.data.pagination.total = ${totalRecords}`
                    );
                } catch (error) {
                    frontendErrors.push(`讀取 pagination.total 失敗: ${error.message}`);
                }
                
                try {
                    const tableData = data.data.data;
                    if (Array.isArray(tableData)) {
                        addTestResult(
                            '步驟 5b: 模擬表格資料處理',
                            'success',
                            `成功讀取表格資料: ${tableData.length} 筆`,
                            `data.data.data 是陣列，包含 ${tableData.length} 筆記錄`
                        );
                    } else {
                        frontendErrors.push(`data.data.data 不是陣列: ${typeof tableData}`);
                    }
                } catch (error) {
                    frontendErrors.push(`讀取表格資料失敗: ${error.message}`);
                }
                
                if (frontendErrors.length > 0) {
                    addTestResult(
                        '步驟 5: 模擬前端處理邏輯',
                        'error',
                        '模擬前端邏輯發現錯誤！',
                        `❌ 錯誤列表:\n${frontendErrors.join('\n')}\n\n完整資料結構:\n${JSON.stringify(data, null, 2)}`
                    );
                } else {
                    addTestResult(
                        '步驟 5: 模擬前端處理邏輯',
                        'success',
                        '模擬前端邏輯完全成功！問題已解決',
                        '所有前端預期的欄位都能正常讀取'
                    );
                }
                
            } catch (error) {
                addTestResult(
                    '步驟 5: 模擬前端處理邏輯',
                    'error',
                    `模擬測試失敗: ${error.message}`,
                    error.stack
                );
            }
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        // 自動開始診斷
        document.addEventListener('DOMContentLoaded', function() {
            log('Point 134 診斷測試頁面已載入');
        });
    </script>
</body>
</html>