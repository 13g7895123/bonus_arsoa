<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Point 134 è¨ºæ–·æ¸¬è©¦ - EForm5 API</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #dc3545;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ccc;
            background-color: #f8f9fa;
        }
        .test-result.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .test-result.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .test-result.warning {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        .btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover {
            background-color: #c82333;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .diagnostic-info {
            background-color: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .step-counter {
            display: inline-block;
            background-color: #6c757d;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            text-align: center;
            line-height: 25px;
            font-size: 12px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Point 134 è¨ºæ–·æ¸¬è©¦</h1>
        <p><strong>å•é¡Œæè¿°:</strong> /wadmin/admin_eeform/eeform_manage_eeform05 é é¢è¼‰å…¥ API /api/eeform/eeform5/list?page=1&limit=20 æ™‚å‡ºç¾ "Cannot read properties of undefined (reading 'total')" éŒ¯èª¤ï¼Œå„˜ç®¡ API è¿”å› 200 ç‹€æ…‹ã€‚</p>

        <div class="diagnostic-info">
            <h3>ğŸ¯ è¨ºæ–·æ­¥é©Ÿ</h3>
            <p>é€™å€‹æ¸¬è©¦å°‡é€æ­¥è¨ºæ–·å•é¡Œï¼Œå¾åŸºæœ¬é€£æ¥åˆ°è³‡æ–™çµæ§‹é©—è­‰ã€‚</p>
        </div>

        <button class="btn" onclick="runFullDiagnosis()">ğŸš€ åŸ·è¡Œå®Œæ•´è¨ºæ–·</button>
        <button class="btn" onclick="clearResults()" style="background-color: #6c757d;">ğŸ§¹ æ¸…é™¤çµæœ</button>

        <div id="test-results"></div>
    </div>

    <script>
        const API_BASE_URL = '/api/eeform/eeform5';
        const ADMIN_PAGE_URL = '/wadmin/admin_eeform/eeform_manage_eeform05';
        
        function log(message) {
            console.log(`[Point 134 è¨ºæ–·] ${new Date().toISOString()}: ${message}`);
        }

        function addTestResult(title, status, content, details = null) {
            const resultsDiv = document.getElementById('test-results');
            const testDiv = document.createElement('div');
            testDiv.className = `test-result ${status}`;
            
            let statusIcon = 'ğŸ”„';
            if (status === 'success') statusIcon = 'âœ…';
            else if (status === 'error') statusIcon = 'âŒ';
            else if (status === 'warning') statusIcon = 'âš ï¸';
            
            let html = `<h4>${statusIcon} ${title}</h4><p>${content}</p>`;
            
            if (details) {
                html += `<div class="code-block">${details}</div>`;
            }
            
            testDiv.innerHTML = html;
            resultsDiv.appendChild(testDiv);
        }

        async function runFullDiagnosis() {
            document.getElementById('test-results').innerHTML = '';
            
            log('é–‹å§‹åŸ·è¡Œ Point 134 å®Œæ•´è¨ºæ–·');
            
            // Step 1: API åŸºæœ¬é€£æ¥æ¸¬è©¦
            await testStep1_BasicConnection();
            
            // Step 2: è³‡æ–™è¡¨æª¢æŸ¥
            await testStep2_TableCheck();
            
            // Step 3: è³‡æ–™çµæ§‹é©—è­‰
            await testStep3_DataStructure();
            
            // Step 4: å‰ç«¯æœŸæœ›æ ¼å¼é©—è­‰
            await testStep4_FrontendExpectation();
            
            // Step 5: æ¨¡æ“¬å‰ç«¯è™•ç†é‚è¼¯
            await testStep5_FrontendLogic();
            
            log('Point 134 è¨ºæ–·å®Œæˆ');
        }

        async function testStep1_BasicConnection() {
            addTestResult(
                'æ­¥é©Ÿ 1: API åŸºæœ¬é€£æ¥æ¸¬è©¦',
                'info',
                'æ¸¬è©¦ API ç«¯é»æ˜¯å¦å¯ä»¥æ­£å¸¸é€£æ¥...'
            );
            
            try {
                const response = await fetch(`${API_BASE_URL}/test`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    addTestResult(
                        'æ­¥é©Ÿ 1: API åŸºæœ¬é€£æ¥æ¸¬è©¦',
                        'success',
                        `API é€£æ¥æ­£å¸¸ï¼Œç‹€æ…‹ç¢¼: ${response.status}`,
                        JSON.stringify(data, null, 2)
                    );
                } else {
                    addTestResult(
                        'æ­¥é©Ÿ 1: API åŸºæœ¬é€£æ¥æ¸¬è©¦',
                        'error',
                        `API é€£æ¥å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`,
                        JSON.stringify(data, null, 2)
                    );
                }
            } catch (error) {
                addTestResult(
                    'æ­¥é©Ÿ 1: API åŸºæœ¬é€£æ¥æ¸¬è©¦',
                    'error',
                    `é€£æ¥å¤±æ•—: ${error.message}`,
                    `URL: ${API_BASE_URL}/test\néŒ¯èª¤: ${error.stack}`
                );
            }
        }

        async function testStep2_TableCheck() {
            addTestResult(
                'æ­¥é©Ÿ 2: è³‡æ–™è¡¨å­˜åœ¨æª¢æŸ¥',
                'info',
                'æª¢æŸ¥ EForm5 ç›¸é—œè³‡æ–™è¡¨æ˜¯å¦å­˜åœ¨...'
            );
            
            try {
                const response = await fetch(`${API_BASE_URL}/test`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.table_exists !== undefined) {
                    if (data.table_exists) {
                        addTestResult(
                            'æ­¥é©Ÿ 2: è³‡æ–™è¡¨å­˜åœ¨æª¢æŸ¥',
                            'success',
                            'è³‡æ–™è¡¨å­˜åœ¨æª¢æŸ¥é€šé',
                            `è³‡æ–™è¡¨ç‹€æ…‹: ${data.table_exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`
                        );
                    } else {
                        addTestResult(
                            'æ­¥é©Ÿ 2: è³‡æ–™è¡¨å­˜åœ¨æª¢æŸ¥',
                            'error',
                            'è³‡æ–™è¡¨ä¸å­˜åœ¨ï¼é€™å¯èƒ½æ˜¯å•é¡Œçš„æ ¹æº',
                            'å»ºè­°: åŸ·è¡Œè³‡æ–™è¡¨å‰µå»º SQL æˆ–æª¢æŸ¥è³‡æ–™åº«é€£æ¥'
                        );
                    }
                } else {
                    addTestResult(
                        'æ­¥é©Ÿ 2: è³‡æ–™è¡¨å­˜åœ¨æª¢æŸ¥',
                        'warning',
                        'API æ²’æœ‰è¿”å›è³‡æ–™è¡¨ç‹€æ…‹è³‡è¨Š',
                        JSON.stringify(data, null, 2)
                    );
                }
            } catch (error) {
                addTestResult(
                    'æ­¥é©Ÿ 2: è³‡æ–™è¡¨å­˜åœ¨æª¢æŸ¥',
                    'error',
                    `æª¢æŸ¥å¤±æ•—: ${error.message}`,
                    error.stack
                );
            }
        }

        async function testStep3_DataStructure() {
            addTestResult(
                'æ­¥é©Ÿ 3: è³‡æ–™çµæ§‹é©—è­‰',
                'info',
                'æ¸¬è©¦å•é¡Œ API ç«¯é»çš„è³‡æ–™çµæ§‹...'
            );
            
            try {
                const response = await fetch(`${API_BASE_URL}/list?page=1&limit=20`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                const rawText = await response.text();
                let data;
                
                try {
                    data = JSON.parse(rawText);
                } catch (parseError) {
                    addTestResult(
                        'æ­¥é©Ÿ 3: è³‡æ–™çµæ§‹é©—è­‰',
                        'error',
                        'API å›å‚³çš„ä¸æ˜¯æœ‰æ•ˆçš„ JSON',
                        `ç‹€æ…‹ç¢¼: ${response.status}\nåŸå§‹å›æ‡‰: ${rawText.substring(0, 500)}`
                    );
                    return;
                }
                
                addTestResult(
                    'æ­¥é©Ÿ 3: è³‡æ–™çµæ§‹é©—è­‰',
                    response.ok ? 'success' : 'error',
                    `API å›æ‡‰ç‹€æ…‹: ${response.status}`,
                    JSON.stringify(data, null, 2)
                );
                
                // é©—è­‰ data çµæ§‹
                if (data.success) {
                    let structureIssues = [];
                    
                    if (!data.data) {
                        structureIssues.push('ç¼ºå°‘ data æ¬„ä½');
                    } else {
                        if (!data.data.data) {
                            structureIssues.push('ç¼ºå°‘ data.data æ¬„ä½');
                        }
                        if (!data.data.pagination) {
                            structureIssues.push('ç¼ºå°‘ data.pagination æ¬„ä½');
                        } else {
                            const pagination = data.data.pagination;
                            if (pagination.total === undefined) structureIssues.push('ç¼ºå°‘ pagination.total');
                            if (pagination.current_page === undefined) structureIssues.push('ç¼ºå°‘ pagination.current_page');
                            if (pagination.total_pages === undefined) structureIssues.push('ç¼ºå°‘ pagination.total_pages');
                            if (pagination.per_page === undefined) structureIssues.push('ç¼ºå°‘ pagination.per_page');
                        }
                    }
                    
                    if (structureIssues.length === 0) {
                        addTestResult(
                            'æ­¥é©Ÿ 3a: è³‡æ–™çµæ§‹è©³ç´°é©—è­‰',
                            'success',
                            'è³‡æ–™çµæ§‹å®Œå…¨ç¬¦åˆå‰ç«¯æœŸæœ›ï¼',
                            `âœ… data.data: ${Array.isArray(data.data.data) ? data.data.data.length : 'N/A'} ç­†è¨˜éŒ„
âœ… data.pagination.total: ${data.data.pagination.total}
âœ… data.pagination.current_page: ${data.data.pagination.current_page}
âœ… data.pagination.total_pages: ${data.data.pagination.total_pages}
âœ… data.pagination.per_page: ${data.data.pagination.per_page}`
                        );
                    } else {
                        addTestResult(
                            'æ­¥é©Ÿ 3a: è³‡æ–™çµæ§‹è©³ç´°é©—è­‰',
                            'error',
                            'è³‡æ–™çµæ§‹ä¸ç¬¦åˆå‰ç«¯æœŸæœ›ï¼',
                            `âŒ å•é¡Œ:\n${structureIssues.join('\n')}\n\nå¯¦éš›çµæ§‹:\n${JSON.stringify(data, null, 2)}`
                        );
                    }
                } else {
                    addTestResult(
                        'æ­¥é©Ÿ 3a: è³‡æ–™çµæ§‹è©³ç´°é©—è­‰',
                        'error',
                        'API å›å‚³ success: false',
                        `éŒ¯èª¤è¨Šæ¯: ${data.message || 'æœªçŸ¥éŒ¯èª¤'}`
                    );
                }
                
            } catch (error) {
                addTestResult(
                    'æ­¥é©Ÿ 3: è³‡æ–™çµæ§‹é©—è­‰',
                    'error',
                    `è«‹æ±‚å¤±æ•—: ${error.message}`,
                    error.stack
                );
            }
        }

        async function testStep4_FrontendExpectation() {
            addTestResult(
                'æ­¥é©Ÿ 4: å‰ç«¯æœŸæœ›æ ¼å¼é©—è­‰',
                'info',
                'é©—è­‰å‰ç«¯ JavaScript æœŸæœ›çš„è³‡æ–™æ ¼å¼...'
            );
            
            const expectedStructure = {
                success: true,
                data: {
                    data: [], // è¡¨æ ¼è³‡æ–™é™£åˆ—
                    pagination: {
                        total: 0, // <- é€™æ˜¯å°è‡´ "Cannot read properties of undefined (reading 'total')" çš„æ¬„ä½
                        current_page: 1,
                        total_pages: 1,
                        per_page: 20
                    }
                }
            };
            
            addTestResult(
                'æ­¥é©Ÿ 4: å‰ç«¯æœŸæœ›æ ¼å¼é©—è­‰',
                'success',
                'å‰ç«¯ JavaScript æœŸæœ›ä»¥ä¸‹è³‡æ–™çµæ§‹:',
                `// å‰ç«¯ä»£ç¢¼ (form5.php ç¬¬619è¡Œ):
admin.totalRecords = data.data.pagination.total;

// æœŸæœ›çš„ API å›æ‡‰æ ¼å¼:
${JSON.stringify(expectedStructure, null, 2)}`
            );
        }

        async function testStep5_FrontendLogic() {
            addTestResult(
                'æ­¥é©Ÿ 5: æ¨¡æ“¬å‰ç«¯è™•ç†é‚è¼¯',
                'info',
                'æ¨¡æ“¬å‰ç«¯å¦‚ä½•è™•ç† API å›æ‡‰...'
            );
            
            try {
                const response = await fetch(`${API_BASE_URL}/list?page=1&limit=20`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                // æ¨¡æ“¬å‰ç«¯é‚è¼¯
                let frontendErrors = [];
                
                try {
                    // é€™æ˜¯æœƒç”¢ç”ŸéŒ¯èª¤çš„è¡Œ
                    const totalRecords = data.data.pagination.total;
                    addTestResult(
                        'æ­¥é©Ÿ 5a: æ¨¡æ“¬å‰ç«¯é‚è¼¯',
                        'success',
                        `æˆåŠŸè®€å– pagination.total: ${totalRecords}`,
                        `data.data.pagination.total = ${totalRecords}`
                    );
                } catch (error) {
                    frontendErrors.push(`è®€å– pagination.total å¤±æ•—: ${error.message}`);
                }
                
                try {
                    const tableData = data.data.data;
                    if (Array.isArray(tableData)) {
                        addTestResult(
                            'æ­¥é©Ÿ 5b: æ¨¡æ“¬è¡¨æ ¼è³‡æ–™è™•ç†',
                            'success',
                            `æˆåŠŸè®€å–è¡¨æ ¼è³‡æ–™: ${tableData.length} ç­†`,
                            `data.data.data æ˜¯é™£åˆ—ï¼ŒåŒ…å« ${tableData.length} ç­†è¨˜éŒ„`
                        );
                    } else {
                        frontendErrors.push(`data.data.data ä¸æ˜¯é™£åˆ—: ${typeof tableData}`);
                    }
                } catch (error) {
                    frontendErrors.push(`è®€å–è¡¨æ ¼è³‡æ–™å¤±æ•—: ${error.message}`);
                }
                
                if (frontendErrors.length > 0) {
                    addTestResult(
                        'æ­¥é©Ÿ 5: æ¨¡æ“¬å‰ç«¯è™•ç†é‚è¼¯',
                        'error',
                        'æ¨¡æ“¬å‰ç«¯é‚è¼¯ç™¼ç¾éŒ¯èª¤ï¼',
                        `âŒ éŒ¯èª¤åˆ—è¡¨:\n${frontendErrors.join('\n')}\n\nå®Œæ•´è³‡æ–™çµæ§‹:\n${JSON.stringify(data, null, 2)}`
                    );
                } else {
                    addTestResult(
                        'æ­¥é©Ÿ 5: æ¨¡æ“¬å‰ç«¯è™•ç†é‚è¼¯',
                        'success',
                        'æ¨¡æ“¬å‰ç«¯é‚è¼¯å®Œå…¨æˆåŠŸï¼å•é¡Œå·²è§£æ±º',
                        'æ‰€æœ‰å‰ç«¯é æœŸçš„æ¬„ä½éƒ½èƒ½æ­£å¸¸è®€å–'
                    );
                }
                
            } catch (error) {
                addTestResult(
                    'æ­¥é©Ÿ 5: æ¨¡æ“¬å‰ç«¯è™•ç†é‚è¼¯',
                    'error',
                    `æ¨¡æ“¬æ¸¬è©¦å¤±æ•—: ${error.message}`,
                    error.stack
                );
            }
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        // è‡ªå‹•é–‹å§‹è¨ºæ–·
        document.addEventListener('DOMContentLoaded', function() {
            log('Point 134 è¨ºæ–·æ¸¬è©¦é é¢å·²è¼‰å…¥');
        });
    </script>
</body>
</html>